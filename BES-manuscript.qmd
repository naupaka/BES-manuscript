---
title: "`neonSoilFlux`: An R Package for Continuous Sensor-Based Estimation of Soil CO~2~ Fluxes"
editor: source
author: 
  - name: John Zobitz
    orcid: 0000-0002-1830-143X
    email: zobitz@augsburg.edu
    affiliations:
      - ref: augsburg 
  - name: Edward Ayres
    orcid: 0000-0001-5190-258X
    affiliations:
      - ref: neon 
  - name: Zoey Werbin
    orcid: 0000-0003-2927-2838
    affiliations:
      - ref: bu
  - name: Ridwan Abdi
    affiliations:
      - ref: augsburg 
  - name: Natalie Ashburner-Wright
    affiliations:
      - ref: usfca
  - name: Lillian Brown
    affiliations:
      - ref: usfca 
  - name: Ryan Frink-Sobierajski
    affiliations:
      - ref: usfca
  - name: Lajntxiag Lee
    affiliations:
      - ref: augsburg 
  - name: Dijonë Mehmeti
    affiliations:
      - ref: augsburg 
  - name: Christina Tran
    affiliations:
      - ref: usfca 
  - name: Ly Xiong
    affiliations:
      - ref: augsburg 
  - name: Naupaka Zimmerman
    orcid: 0000-0003-2168-6390
    email: nbzimmerman@ku.edu
    affiliations:
      - ref: ku
      - ref: usfca 

affiliations:
  - id: augsburg
    name: Augsburg University, 2211 Riverside Avenue, Minneapolis, MN 55454
  - id: neon
    name: National Ecological Observatory Network, Battelle, 1685 38th Street, Suite 100, Boulder, CO 80301
  - id: bu
    name: Boston University, 5 Cummington Street, Boston, MA 02215
  - id: ku
    name: University of Kansas, 1450 Jayhawk Boulevard, Lawrence, KS 66045
  - id: usfca
    name: University of San Francisco, 2130 Fulton Street, San Francisco, CA 94117

    
format:
  pdf:
    include-in-header:
      text: |
        \usepackage{lineno,setspace}
        \linenumbers
        \doublespacing
    keep-tex: true

filters:
  - authors-block

number-sections: true
bibliography: bes-bibliography.bib
csl: methods-in-ecology-and-evolution.csl
---

# Acknowledgments {.unnumbered}

John Zobitz acknowledges Kathleen O'Rourke for code development. Naupaka Zimmerman thanks technical staff at USF for support with field gear assembly and shipping. We thank the NEON field staff and assignable assets teams for facilitating each of the six NEON site visits. We are grateful to LI-COR technical staff for helpful discussions about optimal soil chamber sampling methods. This work was supported by NSF DEB grant #2017829 awarded to John Zobitz, and NSF DEB grant #2017860 awarded to Naupaka Zimmerman. This material is based in part upon work supported by the National Ecological Observatory Network (NEON), a program sponsored by the U.S. National Science Foundation (NSF) and operated under cooperative agreement by Battelle. We also thank the reviewers and subject editor for their constructive feedback.

# Conflict of Interest Statements {.unnumbered}

None of the authors have a financial, personal, or professional conflict of interest related to this work.

# Author Contributions {.unnumbered}

Conceptualization: John Zobitz, Naupaka Zimmerman; Methodology: Edward Ayres, John Zobitz, Naupaka Zimmerman; Software: John Zobitz, Naupaka Zimmerman, Zoey Werbin, Edward Ayres, Dijonë Mehmeti, Ridwan Abdi, Ly Xiong, Lajntxiag Lee; Validation: John Zobitz, Naupaka Zimmerman; Formal Analysis: John Zobitz, Naupaka Zimmerman, Dijonë Mehmeti, Ridwan Abdi, Ly Xiong, Lajntxiag Lee; Investigation: John Zobitz, Naupaka Zimmerman, Ryan Frink-Sobierajski, Christina Tran, Natalie Ashburner-Wright, Lillian Brown; Resources: John Zobitz, Naupaka Zimmerman; Data curation: John Zobitz, Naupaka Zimmerman, Dijonë Mehmeti, Ly Xiong; Writing – original draft: John Zobitz, Naupaka Zimmerman; Writing – review and editing: John Zobitz, Naupaka Zimmerman, Zoey Werbin, Edward Ayres, Christina Tran, Dijonë Mehmeti, Ly Xiong; Visualization: John Zobitz, Naupaka Zimmerman, Dijonë Mehmeti, Ridwan Abdi, Ly Xiong; Supervision: John Zobitz, Naupaka Zimmerman; Project Administration: John Zobitz, Naupaka Zimmerman; Funding Acquisition: John Zobitz, Naupaka Zimmerman.

# Data Availability {.unnumbered}
Data available via [https://doi.org/10.5281/zenodo.17516319](https://doi.org/10.5281/zenodo.17516319) [@zobitzSupportingCodeData2025]. Field-collected data, `neonSoilFlux` calculated outputs, and manuscript-generating code are provided within this repository.

\newpage

# Abstract
1. Accurate quantification of soil carbon fluxes is essential to reduce uncertainty in estimates of the terrestrial carbon sink. However, these fluxes vary over time and across ecosystem types and so it can be difficult to estimate them accurately across large scales. The flux gradient method estimates soil carbon fluxes using co-located measurements of soil CO$_{2}$ concentration, soil temperature, soil moisture, and other soil properties. The National Ecological Observatory Network (NEON) provides such data across 20 ecoclimatic domains spanning the continental U.S., Puerto Rico, Alaska, and Hawai‘i.

2. We present an R software package (`neonSoilFlux`) that acquires soil environmental data to compute half-hourly soil carbon fluxes for each soil replicate plot at a given terrestrial NEON site. To assess the computed fluxes, we visited six focal NEON sites and measured soil carbon fluxes using a closed-dynamic chamber approach.

3. Outputs from the `neonSoilFlux` showed agreement with measured fluxes ($R^{2}$ between measured and `neonSoilFlux` outputs ranging from 0.04 to 0.81 depending on calculation method used); measured outputs generally fell within the range of calculated uncertainties from the gradient method. Calculated fluxes from `neonSoilFlux` aggregated to the daily scale exhibited expected site-specific seasonal patterns.

4. While the flux gradient method is broadly effective, its accuracy is highly sensitive to site-specific inputs, including the extent to which gap-filing techniques are used to interpolate missing sensor data and to estimates of soil diffusivity and moisture content. Future refinement and validation of `neonSoilFlux` outputs can contribute to existing databases of soil carbon flux measurements, providing near real-time estimates of a critical component of the terrestrial carbon cycle.

## Keywords

Soil carbon, carbon dioxide, flux gradient, carbon cycle, field validation, soil respiration, ecosystem variability, diffusion


# Introduction

Soils contain the planet's largest reservoir of terrestrial carbon [@jobbagyVerticalDistributionSoil2000]. A critical component of this reservoir is soil organic matter, the accumulation of which is influenced by biotic factors such as above-ground plant inputs [@jacksonEcologySoilCarbon2017]. These inputs in turn are influenced by environmental factors such as growing season length, temperature, and moisture [@desaiDriversDecadalCarbon2022], which also affect the breakdown of soil organic matter and its return to the atmosphere. Across heterogeneous terrestrial landscapes, the interplay between these biotic and abiotic factors influence the size of the soil contribution to the terrestrial carbon sink [@friedlingsteinGlobalCarbonBudget2025]. However, the heterogeneity of these processes across diverse ecosystems in the context of rapid environmental change leads to large uncertainty about the magnitude of this sink in the future, and thus there remains a pressing need to quantify changes in soil carbon pools and fluxes across scales.

Ecological observation networks such as the United States' National Ecological Observatory Network (NEON) and others (e.g. the globally-distributed FLUXNET or the European Integrated Carbon Observation System) present a significant advancement in the nearly continuous observation of biogeochemical processes at the continental scale. Notably, at 47 terrestrial sites across the continental United States that span 20 ecoclimatic domains, NEON provides half-hourly measurements of soil CO$_{2}$ concentration, temperature, and moisture at different vertical depths. Each of these NEON sites also encompasses measurements of the cumulative sum of all ecosystem carbon fluxes in an airshed using the eddy covariance technique [@baldocchiMeasuringFluxesTrace2014]. Soil observations provided by NEON are on the same timescale and standardized with eddy covariance measurements from FLUXNET. These types of nearly continuous observational data (NEON and FLUXNET) can be used to reconcile differences between model-derived or data-estimated components of ecosystem carbon flux [@luoEcologicalForecastingData2011; @phillipsValueSoilRespiration2017; @shaoBioticClimaticControls2015; @shaoSoilMicrobialRespiration2013; @sihiComparingModelsMicrobial2016; @jianHistoricallyInconsistentProductivity2022].

Estimated or observed soil carbon fluxes are a key metric for understanding change in soil carbon pools over time [@bond-lambertyTwentyYearsProgress2024]. A soil carbon flux to the atmosphere ($F_{S}$, units $\mu$mol m$^{-2}$ s$^{-1}$), represents the aggregate process of transfer of soil CO$_{2}$ to the atmosphere from physical and biological processes (e.g. diffusion and respiration). Soil carbon fluxes can be assumed to encompass soil carbon respiration from autotrophic or heterotrophic sources [@davidsonVariabilityRespirationTerrestrial2006] and modeled with a exponential $Q_{10}$ paradigm [@bond-lambertyGlobalRelationshipHeterotrophic2004; @chenDoesGeneralTemperatureDependent2005; @hamdiSynthesisAnalysisTemperature2013].

One common method by which $F_{S}$ is measured in the field is through the use of soil chambers in a closed, well-mixed system [@normanComparisonSixMethods1997] with headspace trace gas concentrations measured with an infrared gas analyzer (IRGA). $F_{S}$ can also be estimated from soil CO$_{2}$ measurements at different depths in the soil using the flux-gradient method [@maierUsingGradientMethod2014]. Closed-chamber IRGA measurements, while being the most common method, require either frequent in-person site visits or expensive and fragile automated systems. The potential of the gradient method is that fluxes can be estimated from continuous data recorded by robust solid-state sensors. The flux-gradient method is an approach that uses conservation of mass to calculate flux at a vertical soil depth $z$ at steady state by applying Fick's law of diffusion. A simplifying assumption for the flux-gradient method is that there is no mass transfer in the other spatial dimensions $x$ and $y$ [@maierUsingGradientMethod2014]. The diffusivity profile, a key component of this calculation, varies across the soil depth as a function of soil temperature, soil volumetric water content, atmospheric air pressure, and soil bulk density [@millingtonDiffusionAggregatedPorous1971; @sallamMeasurementGasDiffusion1984; @moldrupModelingDiffusionReaction1999].

Databases such as the Soil Respiration Database (SRDB) or the Continuous Soil Respiration Database (COSORE) add to the growing network of resources for making collected observations of soil fluxes available to other researchers [@bond-lambertyCOSORECommunityDatabase2020; @jianRestructuredUpdatedGlobal2021; @jiangGlobalSoilRespiration2024; @bond-lambertyGlobalDatabaseSoil2010; @bond-lambertyNewTechniquesData2018]. However, these databases currently encompass primarily direct soil measurements of fluxes (i.e. those using methods like the closed-chamber method described above). Currently, NEON provides all measurements to calculate $F_{S}$ from Fick's law, but soil flux as a derived data product was descoped from the initial network launch due to budget constraints [@berenbaumReportNSFBIO2015]. Deriving estimates of $F_{S}$ using continuous sensor data across NEON sites using NEON data thus remains a high priority. 

This study describes an R software package, `neonSoilFlux`, that computes a standardized estimate of $F_{S}$ at all terrestrial NEON sites using the flux-gradient method. Using direct chamber-based field observations of soil carbon dioxide flux from a subset of terrestrial NEON sites spanning six states, we provide a direct validation of $F_{S}$ from `neonSoilFlux`. While open source R software tools currently exist for processing chamber-based flux measurements [@zhaoFluxCalRPackageCalculating2019; @jurasinskiFluxFluxRate2022; @rheaultGoFluxUserfriendlyWay2024; @wilsonFluxfinderPackageReproducible2024; @pedersenHMRFluxEstimation2024], to our knowledge this is the first package that incorporates NEON data directly.

Key objectives of this study are to:

1.  Apply the flux-gradient method to estimate soil CO$_{2}$ flux from continuous sensor measurements across six NEON sites.
2.  Benchmark estimated soil carbon fluxes against field measurements (e.g. direct chamber measurements of soil flux).
3.  Identify sources of error in the flux-gradient approach across diverse sites in order to guide future work.

# Materials and Methods

## Field methods

### Focal NEON Sites

In order to acquire field data to validate model predictions of flux, we selected six terrestrial NEON sites for analysis. We conducted roughly week-long field measurement campaigns at these sites, which span a range of environmental gradients and terrestrial domains (@tbl-neon-sites). SJER, SRER, and WREF were visited during May and June of 2022, and WOOD, KONZ, and UNDE during May and June of 2024. Permits or waivers were sought and approved prior to field work at all six sites. In 2022, research activities were conducted whole or in part on the Wind River Experimental Forest within the Gifford Pinchot National Forest. No permit was required for this work. Approval for research at San Joaquin Experimental Range was granted by Dr. Angela White in May 2022 and for research at Santa Rita Experimental Range by Dr. Mitch McClaran in May 2022. In 2024, permits were received for work at WOOD (Chase Lake WMD; permit number 62515-24-020), KONZ (Konza Prairie Biological Station; permit number 766), and UNDE (University of Notre Dame Environmental Research Center; permit number UNDERC-2024-5).

### Soil collar placement

Either one (2022 sampling campaign) or two (2024 sampling campaign) PVC soil collars (20.1 cm inside diameter) were installed in close proximity to the permanent NEON soil sensors at each site (@fig-collar-images). As instruments in the NEON soil sensor arrays can occasionally break down or stop working, the specific soil plot where we made measurements was chosen at each site in consultation with NEON staff to maximize likelihood of quality soil sensor measurements during the duration of the IRGA measurements. The plot selected at each site (out of the 5 in each replicate array at each site) are presented in the last column of @tbl-neon-sites. After installation, collar(s) were left to equilibrate for approximately 24 hours prior to any measurements being taken.

### Infrared gas analyzer measurements of soil CO$_{2}$ flux

In 2022, we then made measurements of flux on an hourly interval for 8 hours each day. Measurements were taken from roughly 8 am to 4 pm, with the time interval selected to capture the majority of the diurnal gradient of soil temperature each day. These measurements were made using a LI-6800 infrared gas analyzer instrument (LI-COR Environmental, Lincoln, NE) fitted with a soil chamber attachment (attachment 6800-09). In 2024, we again used the same LI-6800 instrument, but made half-hourly measurements over an approximately 8 hour period. In addition, in 2024 we also installed a second collar and used a second instrument, an LI-870 CO$_{2}$ IRGA, connected to an automated robotic chamber (LI-COR chamber 8200-104) controlled by an LI-8250 multiplexer to make automated measurements. The multiplexer was configured to take half-hourly measurements 24 hours a day for the duration of our sampling bout at each site. Each instrument was paired with a soil temperature and moisture probe (Stevens HydraProbe, Stevens Water, Portland, OR) that was used to make soil temperature and moisture measurements concurrent with the CO$_{2}$ flux measurements. Chamber volumes were set by measuring collar offsets at each site. System checks were conducted daily for the LI-6800 and weekly for the LI-8250. Instruments were factory calibrated before each field season.

::: {#fig-collar-images}
![](figures/collar-images.jpeg)

Spatial layout of field sampling using a closed-dynamic chamber setup at a representative NEON site (KONZ). Left image shows collars (white arrows) and permanent soil sensor installation (black arrow) and right image shows the LI-6800 (foreground) and LI-8200-104 (background) instruments placed on the collars.
:::

::: {#tbl-neon-sites}
\tiny

| Site | Location | Ecosystem | MAT | $\overline{T_{S}}$ | MAP | $\overline{SWC}$ | Dates | Plot |
|--------|--------|--------|--------|--------|--------|--------|--------|--------|
| SRER | 31.91068, -110.83549 | Shrubland | 19.3 $^{\circ}$C | 47.6 $^{\circ}$C | 346 mm | 4.0% | May 29-- June 1 2022 | 004 |
| SJER | 37.10878, -119.73228 | Oak woodland | 16.4 $^{\circ}$C | 41.7 $^{\circ}$C | 540 mm | 1.2% | June 1--4 2022 | 005 |
| WREF | 45.82049, -121.95191 | Evergreen forest | 9.2 $^{\circ}$C | 15.3 $^{\circ}$C | 2225 mm | 27.2% | June 7--9 2022 | 001 |
| WOOD | 47.1282, -99.241334 | Restored prairie | 4.9 $^{\circ}$C | 14.9 $^{\circ}$C | 495 mm | 14.9% | June 3--9 2024 | 001 |
| KONZ | 39.100774, -96.563075 | Tallgrass prairie | 12.4 $^{\circ}$C | 23.4 $^{\circ}$C | 870 mm | 23.4% | May 29-- June 1 2024 | 001 |
| UNDE | 46.23391, -89.537254 | Deciduous forest | 4.3 $^{\circ}$C | 13.0 $^{\circ}$C | 802 mm | 13.0% | May 22--25 2024 | 004 |

\normalsize

Listing of NEON sites studied for field work and analysis. Site refers to NEON site codes: Santa Rita Experimental Range (SRER), San Joaquin Experimental Range (SJER), Wind River Experimental Forest (WREF), Chase Lake National Wildlife Refuge (WOOD), Konza Prairie Biological Station (KONZ), and the University of Notre Dame Environmental Research Center (UNDE). Location is reported in decimal degrees of latitude and longitude. Other abbreviations include Mean Annual Temperature (MAT); $\overline{T_{S}}$: average soil temperature during field measurements; $\overline{SWC}$: average soil water content during field measurements. Dates refer to field measurement dates for each site. Plot refers to the particular location in the soil sensor array (denoted as HOR by NEON) where field measurements were made.
:::

### Post-collection processing of field data

We used LI-COR SoilFluxPro software (v 5.3.1) to assess the data after collection and to inform sampling parameters. We checked appropriateness of dead band and measurement durations using built-in evaluation tools. Based on this, the deadband period was set for 30-40 seconds, depending on the site, and the measurement duration was 180 seconds with a 30 second pre-purge and a 30 second post-purge at most sites, and a 90 second pre- and post-purge at sites with higher humidity due to recent precipitation events. We also assessed the $R^{2}$ of linear and exponential model fits to measured CO$_{2}$ to verify measurement quality.

## `neonSoilFlux` R package {#sec-nsf-desc}

We developed an R package called `neonSoilFlux` [@zobitzNeonSoilFluxComputeSoil2024] to compute half-hourly soil carbon fluxes and uncertainties from NEON data. The objective of the `neonSoilFlux` package is a unified workflow (@fig-package-diagram) for soil data acquisition and analysis that supplements the existing `neonUtilities` data acquisition R package [@lunchNeonUtilitiesUtilitiesWorking2025].

::: {#fig-package-diagram}
![](figures/neonSoilFluxOutline.png)

Diagram of `neonSoilFlux` R package. For a given month, year, and NEON site (orange parallelogram), the package acquires all relevant data to compute $F_{S}$ using the `neonUtilities` R package (green rectangle). Data are gap-filled according to reported QA flags and adjusted for changes in soil water content (SWC) calibration coefficients, then interpolated to the same measurement depth before computing the soil flux, uncertainties, and final QA flags (blue rectangles). The package reports the associated soil flux, uncertainties, and quality assurance (QA) flags for the user (purple parallelogram).
:::

At a given NEON site there are five replicate soil plots, each with measurements of soil CO$_{2}$ concentration, soil temperature, and soil moisture at different depths (@fig-model-diagram). The `neonSoilFlux` package acquires measured soil CO$_{2}$ concentration [@neonSoilCO2], soil temperature [@neonSoilTemp], soil water content [@neonSoilWater], barometric pressure from the nearby tower [@neonBarometricPressure], and soil properties (e.g. bulk density) [@neonSoilProperties] from a range of different NEON data products. The static soil properties were collected by NEON staff from a nearby soil pit during initial site characterization and are assumed to be constant at each site. A soil flux calculation is computed at each replicate soil plot.

::: {#fig-model-diagram}
![](figures/model-diagram.pdf){fig-alt="Diagram of model workflow"}

Model diagram of the data workflow for the `neonSoilFlux` R package. a) Acquire: Data are obtained for a given NEON location and horizontal sensor location, which includes soil water content, soil temperature, CO$_{2}$ concentration, and atmospheric pressure. All data are screened for quality assurance; if gap-filling of missing data occurs, it is flagged for the user. b) Harmonize: Any belowground data are then harmonized to the same depth as CO$_{2}$ concentrations using linear regression. c) Compute: The flux across a given depth is computed via Fick's law, denoted with $F_{ijk}$, where $i$, $j$, or $k$ are either 0 or 1 denoting the layers the flux is computed across ($i$ = closest to surface, $k$ = deepest). $F_{000}$ represents a flux estimate where the gradient $dC/dz$ is the slope of a linear regression of CO$_{2}$ with depth.
:::

The workflow to compute a value of $F_{S}$ with `neonSoilFlux` consists of three primary steps, illustrated in @fig-model-diagram. First, NEON data are acquired for a given site and month via the `neonUtilities` R package (yellow parallelogram and green rectangle in @fig-package-diagram and Panel a in @fig-model-diagram). Acquired environmental data can be exported to a comma separated value file for additional analysis. Quality assurance (QA) flags are reported as an indicator variable. Since the calibration coefficients on the soil water content sensors have changed over time [@neonSoilWater], raw sensor measurements were back-calculated and soil-specific calibrations were applied following @ayresValidationRemotelySensed2024 to generate a consistent time series at each measurement location.

The second step is harmonizing the data to compute soil fluxes across soil layers. This step consists of three different actions (blue rectangles in @fig-package-diagram and Panel b in @fig-model-diagram). If a given observation by NEON is reported as not passing a quality assurance check, we applied a gap filling method to replace that measurement with its monthly mean at that same depth (@sec-gapfilling). Belowground measurements of soil water and soil temperature are then interpolated to the same depth as soil CO$_{2}$ measurements. The diffusivity (@sec-compute-diffusivity) and soil flux across different soil layers (@sec-compute-soil-flux) are then computed.

The third and final step is computing a surface soil flux through extrapolation to the surface (purple parallelogram in @fig-package-diagram and Panel c in @fig-model-diagram). Uncertainty on a soil flux measurement is computed through quadrature. An aggregate quality assurance (QA) flag for each environmental measurement is also reported, representing if any gap-filled measurements were used in the computation of a soil flux. Within the soil flux-gradient method, several different approaches can be used to derive a surface flux [@maierUsingGradientMethod2014]; the `neonSoilFlux` package reports four different possible values for soil surface flux (@sec-compute-soil-flux) for each of two different methods of diffusivity estimation, for a total of eight estimates of flux.

### Gap-filling routine {#sec-gapfilling}

NEON reports QA flags as binary values for each measurement and half-hourly interval. For a given half-hour, if any input variable (soil CO$_2$ concentration, soil temperature, or soil moisture) at depth $z$ is flagged, computation of $F_S$ is not possible. To address this, flagged measurements and their uncertainties were replaced with a bootstrapped monthly mean ($\overline{m}$) and monthly standard deviation ($\overline{s}$) [@efronIntroductionBootstrap1994].

For each month, depth $z$, and variable, we computed bootstrapped estimates of $\overline{m}$ and $\overline{s}$ from the vectors of unflagged measurements ($\mathbf{m}$), reported standard errors ($\boldsymbol\sigma$), and the 95% confidence interval ($\boldsymbol\epsilon$, or expanded uncertainty; @farranceUncertaintyMeasurementReview2012). We also defined a bias vector $\mathbf{b}=\sqrt{\boldsymbol\epsilon^{2}-\boldsymbol\sigma^{2}}$, which quantifies the spread of uncertainty in a given period and is incorporated into $\overline{m}$.

From these, 5000 bootstrap samples were generated for $\mathbf{m}, \boldsymbol\sigma$, and $\mathbf{b}$. For each sample ($m_k, b_k, \sigma_k$), we generated a vector $\mathbf{n}$ (length $N=5000$) by drawing from a normal distribution with mean $m_k+b_k$ and standard deviation $\sigma_k$. The sample mean and standard deviation were then computed from $\mathbf{n}$. The resulting distributions of sample means and sample standard deviations provided the bootstrapped monthly mean ($\overline{m}$) and standard error ($\overline{s}$) respectively.

This gap-filling procedure provides a consistent treatment across all data streams. However, alternative approaches may be better suited for longer gaps (e.g., correlations with other NEON measurement levels or soil plots) or for variable-specific conditions. We discuss the effect of gap-filling on our results in @sec-general-eval.

### Soil diffusivity {#sec-compute-diffusivity}

Soil diffusivity $D_{a}$ at a given measurement depth is the product of the diffusivity in free air $D_{a,0}$ (m$^{2}$ s$^{-1}$) and the tortuosity $\xi$ (no units) [@millingtonDiffusionAggregatedPorous1971].

We compute $D_{a,0}$ with Equation \ref{eq:da0}:

\begin{equation}
  D_{a,0} = 0.0000147 \cdot \left( \frac{T_{i} + 273.15}{293.15} \right)^{1.75} \cdot \left( \frac{P}{101.3} \right)
  \label{eq:da0}
\end{equation}

where $T_{i}$ is soil temperature ($^\circ$C) at depth $i$ [@neonSoilTemp] and $P$ surface barometric pressure (kPa) [@neonBarometricPressure].

Previous studies by @sallamMeasurementGasDiffusion1984 and @tangAssessingSoilCO22003 demonstrated the sensitivity of modeled $F_{S}$ depending on the tortuosity model ($\xi$) used to compute diffusivity. At low soil water content, the choice of tortuosity model can lead to order-of-magnitude differences in $D_{a}$, which in turn affect modeled $F_{S}$. The `neonSoilFlux` package currently includes two approaches to calculate $\xi$, representing the range of tortuosity behavior reported in @sallamMeasurementGasDiffusion1984.

The first approach is the Millington-Quirk model [@millingtonDiffusionAggregatedPorous1971], in which tortuosity depends on both porosity and soil water content:

\begin{equation}
  \xi = \frac{(\phi - SWC_{i})^{10/3}}{\phi^{2}}
  \label{eq:tortuosity-mq}
\end{equation}

In Equation \ref{eq:tortuosity-mq}, $SWC$ is the soil water content at depth $i$ [@neonSoilWater] and $\phi$ is the porosity, which in turn is a function of soil physical properties [@neonSoilProperties]:

\begin{equation}
  \phi = \left(1- \frac{\rho_{s}}{\rho_{m}} \right) \left(1-f_{V}\right)
  \label{eq:porosity}
\end{equation}

In Equation \ref{eq:porosity}, $\rho_{m}$ is the particle density of mineral soil (2.65 g cm$^{-3}$), $\rho_{s}$ the soil bulk density (g cm$^{-3}$) excluding coarse fragments greater than 2 mm [@neonSoilProperties], and $f_{V}$ is a site-specific value that accounts for the proportion of soil fragments between 2-20 mm. Soil fragments greater than 20 mm were not estimated due to limitations in the amount of soil that can be analyzed [@neonSoilProperties]. We assume that rock fragments contain no internal pores.

The Millington-Quirk model assumes $\xi$ is modulated by the amount of fluid saturation in soil pores [@millingtonDiffusionAggregatedPorous1971]. In contrast, the Marshall model [@marshallDiffusionGasesPorous1959] expresses tortuosity as only a function of porosity ($\xi = \phi^{1.5}$), with $\phi$ defined from Equation \ref{eq:porosity}. The Marshall model is independent of soil water content and assumes tortuosity is only governed by soil structure. The `neonSoilFlux` package allows users to choose the tortuosity model most appropriate for site-specific conditions and research goals.

### Soil flux computation {#sec-compute-soil-flux}

We applied Fick's law (Equation \ref{eq:ficks}) to compute the soil flux $F_{ij}$ ($\mu$mol m$^{-2}$ s$^{-1}$) across two soil depths $i$ and $j$:

\begin{equation}
  F_{ij} = -D_{a} \frac{dC}{dz}
  \label{eq:ficks}
\end{equation}

where $D_{a}$ is the diffusivity (m$^{2}$ s$^{-1}$) and $\frac{dC}{dz}$ is the gradient of CO$_{2}$ molar concentration ($\mu$mol m$^{-3}$, so the gradient has units of $\mu$mol m$^{-3}$ m$^{-1}$). The soil surface flux is theoretically defined by applying Equation \ref{eq:ficks} to measurements collected at the soil surface and directly below the surface. Measurements of soil temperature, soil water content, and soil CO$_{2}$ molar concentration across the soil profile allow for application of Equation \ref{eq:ficks} across different soil depths. Each site had three measurement layers, so we denote the flux as a three-digit subscript $F_{ijk}$ with indicator variables $i$, $j$, and $k$ indicate if a given layer was used (written in order of increasing depth), according to the following:

-   $F_{000}$ is a surface flux estimate using the intercept of the linear regression of $D_{a}$ with depth and the slope from the linear regression of CO$_{2}$ with depth (which represents $\displaystyle \frac{dC}{dz}$ in Fick's Law). @tangAssessingSoilCO22003 used this approach to compute fluxes in an oak-grass savannah.
-   $F_{110}$ is a flux estimate across the two shallowest measurement layers.
-   $F_{011}$ is a flux estimate across the two deepest measurement layers.
-   $F_{101}$ is a flux estimate across the shallowest and deepest measurement layers.

For $F_{110}$, $F_{011}$, and $F_{101}$, the diffusivity used in Fick's Law is always at the deeper measurement layer. When used as a surface flux estimate we assume CO$_{2}$ remains constant above this flux depth. Uncertainty in all $F_{ijk}$ values was quantified using quadrature [@taylorIntroductionErrorAnalysis2022]. These computed fluxes could provide the basis for additional soil flux estimates. For example, @tangContinuousMeasurementsSoil2005 estimated surface flux by linearly extrapolating $F_{110}$ and $F_{011}$ to the soil surface.

## Post processing evaluation {#sec-post-process}

Following collection of field measurements and calculation of the soil fluxes from `neonSoilFlux` package, we compared measured $F_{S}$ based on closed-dynamic chamber measurements with the LI-COR instruments to a given soil flux calculation from `neonSoilFlux` for each site and flux computation method and quantified the relationship statistically (R$^{2}$). Finally, for a half-hourly interval we also computed a *post hoc* diffusivity ($D_{a}$) using the LI-COR flux along with the CO$_{2}$ surface gradient reported by NEON using the measurement levels closest to the surface.

# Results

## Concordance between modelled and measured soil CO$_{2}$ flux

The sites we visited ranged substantially in both their annual average temperature and precipitation as well as their biome type (@tbl-licor-results). These differences also influenced the wide range of observed flux rates across sites.

::: {#tbl-licor-results}
```{r licor-results, results='asis', echo=FALSE, message=FALSE}
library("dplyr")
library("kableExtra")
load("data/derived/licor-all-data.Rda")

licor_all_data %>%
  filter(instrument == "6800") %>%
  group_by(site) %>%
  summarize(mean_flux = round(mean(fluxes), digits = 2),
            sd_flux = round(sd(fluxes), digits = 2),
            mean_soil_temp = round(mean(soilTemp), digits = 2),
            sd_soil_temp = round(sd(soilTemp), digits = 2),
            mean_vswc = round(mean(VSWC), digits = 2),
            sd_vswc = round(sd(VSWC), digits = 2),
            n = n()) %>%
  mutate(flux = paste(mean_flux, "$\\pm$", sd_flux),
         soil_temp = paste(mean_soil_temp, "$\\pm$", sd_soil_temp),
         vswc = paste(mean_vswc, "$\\pm$", sd_vswc)) %>%
  select(site, flux, soil_temp, vswc, n) %>%
  arrange(factor(site, levels = c("UNDE", "WOOD", "WREF", "KONZ", "SJER", "SRER"))) %>%
  knitr::kable(format = "latex",
               booktabs = TRUE,
               linesep = "",
               escape = FALSE,
               align = rep("c", 5),
               col.names = linebreak(c("Site",
                             "Flux\n $\\mu$mol m$\\textsuperscript{-2}$ s$\\textsuperscript{-1}$",
                             "Soil temp\n °C",
                             "VSWC\n cm$\\textsuperscript{3}$ cm$\\textsuperscript{-3}$",
                             "n"),
                             align = "c"))
```

Summary of measured soil characteristics and flux results from field measurements across six NEON sites using a LI-COR 6800 (LI-870/8250 measurements omitted to enable direct comparability) via the closed-dynamic chamber method. Numeric values for soil CO$_{2}$ flux, soil temperature, and volumetric soil water content (VSWC) are the mean and standard deviation of field measurements at each site.
:::

The timeseries of the measured fluxes from the LI-COR 6800 and 870/8250 were compared to modeled soil fluxes from the `neonSoilFlux` R package (@fig-flux-results). We also assessed year-long estimated flux time series and compared those to field measurements made at each site (@fig-flux-results-year). Results are reported in local time. Where applicable, sites are displayed from left to right by increasing soil temperature (@tbl-neon-sites). Positive values of the flux indicate that there is a flux moving towards the surface. Overall, with the exception of SRER (discussed later) the computed fluxes determined using a variety of plausible methods spanned the field-measured fluxes, but the specific flux-gradient method that best approximated field measurements varied by site.

::: {#fig-flux-results}
![](figures/flux-results.png)

Timeseries of soil surface flux ($F_{S}$) from field-measured (yellow lines) and modeled soil fluxes (green or purple lines) by the `neonSoilFlux` R package. Fluxes from the `neonSoilFlux` R package are separated by the diffusivity model used (Millington-Quirk or Marshall, @sec-compute-diffusivity). Individual vertical axis labels in the first column represent the measurement levels where the flux-gradient approach is applied (@sec-compute-soil-flux). Ribbons for modeled soil fluxes represent $\pm$ 1 standard deviation. Results are reported in local time. WREF, SJER, and SRER were sampled in 2022, and UNDE, WOOD, and KONZ were sampled in 2024. Sites (columns) are arranged from left to right in terms of increasing mean annual temperature.
:::

::: {#fig-flux-results-year}
![](figures/flux-results-year.png)

Timeseries of both daily-averaged field $F_{S}$ (yellow circles) and daily ensemble averaged soil fluxes (average of $F_{000}$, $F_{101}$, $F_{011}$, $F_{110}$, @sec-compute-soil-flux) by the `neonSoilFlux` R package, separated by the diffusivity model used (green or purple lines, Millington-Quirk or Marshall, @sec-compute-diffusivity).
:::

We calculated a statistical relationship between the various estimates of soil flux computed by `neonSoilFlux` and the field-measured fluxes within daily interval periods. Statistics for these comparisons are reported in @fig-r2-plot, which also shows how these fall relative to a 1:1 line.

::: {#fig-r2-plot}
![](figures/r2-plot.png){width=60%}

Statistical comparison between measured fluxes at each NEON site with fluxes reported by `neonSoilFlux` with the different flux calculation approaches and diffusivity calculations applied. Points are daily averages and LICOR $F_{S}$ values are from the 6800 instrument only, for consistency. The dotted line represents a 1:1 relationship, and the reported R^2^ quantifies the relationship between field-measured and `neonSoilFlux` estimated fluxes.  \* = significance at the 5% level, \*\* = significance at the 1% level. The slope ($m$) and intercept ($b$) of the linear regression between measured and modeled fluxes are also reported. The low-value outlier from KONZ in the $F_{110}$ Marshall plot is an example of the effect of inverted CO~2~ gradients causing an estimated flux to be negative, bringing down the daily mean, which later resolved as the soils dried back out.
:::

## Effects of method choice on diffusivity estimates

In four of six field sites, the *post hoc* $D_{a}$ estimate fell roughly between the two diffusion estimation methods; however this was less the case in the two driest sites, SJER and SRER (@tbl-neon-sites), where the field estimate of diffusivity was either lower or higher than both of the other methods (@fig-diffusivity-plot).

::: {#fig-diffusivity-plot}
![](figures/diffusivity-plot.png)

Distribution of diffusivity ($D_{a}$) at each study site. Values of $D_{a}$ were provided by the `neonSoilFlux` package, computed from the Millington-Quirk or Marshall models (@sec-compute-diffusivity). A post-hoc estimate of diffusivity (labeled as "Field estimated") was computed through the field measured flux (@fig-flux-results), divided by the CO$_{2}$ gradient from the measurement levels closest to the soil surface, as reported by NEON. We only used $F_{S}$ measured by the LICOR 6800 at all sites to standardize comparisons. Some outliers (n = 1 from the field estimated values at KONZ and n = 6 from field estimated values at SRER) are excluded from the plot to allow better comparative visualization across sites. 
:::

# Discussion {#sec-discussion}

This study presents a unified data science workflow to efficiently process automated measurements of belowground soil CO$_{2}$ concentrations, soil water content, and soil temperature to infer estimates of soil surface CO$_{2}$ effluxes through application of Fick's Law (Equation \ref{eq:ficks}). Our core goals in this study were: (1) to generate estimates of soil flux from continuous soil sensor data at terrestrial NEON sites using the flux-gradient method and then (2) to compare those estimates to field-measured fluxes based on the closed chamber approach at six NEON focal sites. We discuss our progress toward these core goals through (1) an overall evaluation of the flux-gradient approach (and uncertainty calculation) and (2) site-specific evaluation of differences in estimated vs measured fluxes.

## General evaluation of flux-gradient approach {#sec-general-eval}

Key assumptions of the flux-gradient approach are that CO$_{2}$ concentrations increase throughout the soil profile such that the highest concentrations are observed in the deepest layers. Additionally, field flux measurements should correlate with $F_{000}$ because they represent surface fluxes. Periods where this gradient condition are not met generally are connected to processes that occur during soil wetting events, where more shallow soil layers produce higher concentrations of CO$_{2}$ due to microbial respiration pulses following rewetting. This effect is likely to be largest at sites with rich organic soils (e.g. KONZ). Based on this reasoning, in these types of situations we would *a priori* expect $F_{011} \mbox{ (deepest layers) } \leq F_{101} \leq F_{110} \mbox{ (shallow layers) } \leq F_{000} \mbox{ (all layers) }$ because the previous flux estimates rely primarily on CO$_2$ concentrations at deeper depths, and could miss high concentrations of CO$_{2}$ produced in shallower layers.

When modeling soil respiration, typically a non-linear response function that also considers soil type is used [@boumaAssessmentRootSoil2000; @yanPorescaleInvestigationResponse2016; @yanMoistureFunctionSoil2018]. For the `neonSoilFlux` package, soil type is connected to the measurement of bulk density, which was characterized at each NEON site. This bulk density estimate is based on replicate samples collected from the site megapit at a subset of soil horizons, with an estimated uncertainty of $\pm5\%$ [@neonSoilProperties]. Coarse fragment estimates also have very large uncertainties, but because the volume fraction tends to be low in surface soils it is unlikely to contribute much additional flux uncertainty.

Our results suggest that the most important way to improve reliability of the flux estimate is to reduce the usage of gap-filled data. The current approach to gap filling in `neonSoilFlux` uses monthly mean data to gap fill---this approach decreases the ability of the estimate to be responsive to short-term pulses that occur with rapid weather shifts. Four sites (KONZ, SRER, WREF, and UNDE) had more than 75% of half-hourly periods with no-gap filled measurements (Figure S1, Supplementary Information). Two sites (SJER and WOOD) had more than 75% of half-hourly intervals with just one gap-filled measurement. The large uncertainty evident in @fig-flux-results for estimates from WOOD and SJER are thus due in part to the gap-filling used in these sites (Figure S1). While we did not need to use gap-filled measurements to compute the flux at WREF, field data collection occurred following a severe rainstorm, with soils at the beginning of the sampling week near their water holding capacity. In general, we recommend that whenever possible, knowledge of local field conditions should influence analysis decisions in addition to any QA filtering protocols in the `neonSoilFlux` package.

We recognize that this gap-filling approach may lead to gap-filled values that are quite different from the actual values, such as an underestimate of soil moisture following rain events. Further extensions of the gap filling method could use more sophisticated gap-filling routines, similar to what is used for net ecosystem carbon exchange [@falgeGapFillingStrategies2001; @moffatComprehensiveComparisonGapfilling2007; @mariethozFeaturepreservingInterpolationFiltering2015; @liuRobustGapfillingApproach2023; @zhangTemporalGapFilling12Hourly2023]. Additionally, since the deepest temperature and soil moisture sensors are located below the deepest CO~2~ sensors at NEON sites, it is possible that excluding these deeper layers from consideration prior to analysis would lead to a reduced need for gap filling. Future iterations of the `neonSoilFlux` package may incorporate this as an option. The current gap-filling routine provides a consistent approach that can be applied to each data stream, but further work may explore alternative gap-filling approaches.

## Evaluation of flux-gradient approach at each site

Derived results from the `neonSoilFlux` package have patterns that are broadly consistent with those directly measured in the field (@fig-flux-results and @fig-flux-results-year), even though statistical comparisons between the field-measured and `neonSoilFlux` values were quite variable (e.g. $R^{2}$ ranging from 0.04 to 0.81; @fig-r2-plot). One advantage of the `neonSoilFlux` package is its ability to calculate fluxes across different soil depths (@fig-model-diagram), which allows for additional site-specific customization. We believe the package can provide a useful baseline estimate of soil fluxes that can always be complemented through additional field measurements.

The six locations studied provide a range of case studies that suggest different considerations may apply to different sites when applying the flux-gradient method. For example, the Santa Rita Experimental Range (SRER) is a desert site characterized by sandy soil, which also was the location of the highest field soil temperatures that we observed (@tbl-licor-results). At SRER the flux across the top two layers ($F_{110}$) produced a pattern of soil flux most consistent with the observed field data. The remaining methods $F_{101}$, $F_{011}$, or $F_{000}$ are derived from information taken from the deepest layer, which seems to have been decoupled from the surface layers both in terms of temperature and CO$_{2}$ concentration. This may be a general circumstance where there are large diurnal temperature extremes that rapidly change during the course of a day and overnight, leading to lags in the timing of when temperature increases propagate down to deeper soil layers.

Immediately prior to our visit to Konza Prarie (KONZ), that site that experienced a significant rain event that led to wet soils that gradually dried out over the course of our time there. This pulse of precipitation increased the soil CO$_{2}$ concentration at the top layer above the concentrations in lower layers, leading to negative estimated flux values at the start of the field sampling period. In this case it was only when the soil began to return to a baseline level that the assumptions of the flux-gradient method were again met.

Both of the previous cases also provide context for the variable statistical comparisons between field-measured soil fluxes and `neonSoilFlux` outputs (@fig-r2-plot). When considering systematic deployment of this method across a measurement network, there are a number of independent challenges that require careful consideration. There are clear tradeoffs between (1) accuracy of modeled fluxes (defined here as closeness to field-measured $F_{S}$ and the uncertainty reduction factor $\epsilon$), (2) precision (which could be defined by the signal to noise ratio), and (3) the choice of the diffusivity model (@sec-compute-diffusivity) or flux computation method (@sec-compute-soil-flux). A sensitivity analysis (Figure S2, Supplemental Information) found that flux output uncertainty was dominated by measurement uncertainty ($T_{S}$, $P$, $SWC$, or CO$_{2}$) rather than by the diffusivity method used to compute soil flux. Notably, the $F_{110}$ method was least sensitive to measurement uncertainty likely because it best aligns with the surface chamber measurement assumptions.

Finally, comparing the effects of different diffusivity estimation methods on the match between modeled and measured fluxes (@fig-flux-results-year) highlights the sensitivity of $F_{ijk}$ to diffusivity. The comparison between diffusivity estimates compared to field estimated diffusivity (@fig-diffusivity-plot) demonstrates that site parameters can dictate which measure of diffusivity is most likely to be accurate in a given environmental context. Site-specific differences are largely a reflection of differences in soil moisture across the sites (@tbl-neon-sites), as not all diffusivity estimation methods incorporate soil moisture equivalently. While we here have compares two approaches to calculate diffusivity (the Millington-Quirk and Marshall models), it may be valuable to evaluate other diffusivity models (e.g. the Moldrup model; @moldrupModelingDiffusionReaction1999) as well. Ultimately the choice of a particular diffusivity model could be determined based on knowledge of site-specific evaluations or a set of these models could be used to generate a model ensemble average as a means to trade precision for a more general approach.

## Recommendations for future method development

The `neonSoilFlux` package provides several approaches to estimate soil flux using the gradient method. We believe these approaches enable the software to be used across a range of site-specific assumptions [@maierUsingGradientMethod2014]. We note, however, that this choice can have a determinative approach on the calculated values. Ensemble averaging approaches [@rafteryUsingBayesianModel2005; @elshallRelativeModelScore2018] may be one way to address this problem if the goal is to calculate fluxes using the same method at a diverse range of different sites. Two other ideas would be to apply machine learning algorithms (e.g. random forest) to generate a single flux estimate across diverse sites, or using co-located estimates of net ecosystem carbon exchange from eddy-flux towers to further constrain results or to assess soil flux results for plausibility [@phillipsValueSoilRespiration2017].

These challenges notwithstanding, the method used here and made available in the `neonSoilFlux` R package has the potential to produce nearly continuous estimates of flux across all terrestrial NEON sites. These estimates are a significant improvement on available approaches to constrain the portion of ecosystem respiration attributable to the soil. This, in turn, also aids in our ability to understand the soil contribution to the net ecosystem flux measured at these sites using the co-located eddy flux towers.

# Conclusions

We used the R package `neonSoilFlux` to estimate soil CO$_2$ fluxes with the flux-gradient method using data from buried soil sensors at NEON terrestrial sites. We compared the predicted fluxes to those measured directly using a field-based closed chamber approach. Soil fluxes from `neonSoilFlux` were broadly effective at producing estimates of flux comparable to those measured in the field using a chamber-based technique. However `neonSoilFlux` outputs are quite sensitive to a number of issues, including: missing data (and thus gap-filling of input measurement datasets), the selection of soil depths used to best calculate the gradient (which may vary between sites), and finally the choice of method used for estimating soil diffusivity. The flexibility of the `neonSoilFlux` package allows the user to evaluate each of these issues with site-specific knowledge and contexts. Future refinements and subsequent validation of `neonSoilFlux` outputs will feed forward into evaluating soil carbon fluxes broader spatial scales to enhance understanding of the ways in which soils across diverse ecosystems are responding to a changing climate.

# Sources Cited
